name: Docspec generate

on:
  workflow_dispatch:
    inputs:
      markdown_file:
        description: 'Path to markdown file (e.g., README.md)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: docspec-generate-${{ github.repository }}-${{ inputs.markdown_file }}
  cancel-in-progress: false

jobs:
  generate_docspec:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install docspec CLI
        run: npm install -g docspec

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Prepare docspec generate prompts
        id: prepare_prompts
        shell: bash
        run: |
          python3 .github/scripts/prepare-docspec-generate-prompts.py > prompts_output.txt
          # Extract plan prompt
          sed -n '/===PLAN_PROMPT_START===/,/===PLAN_PROMPT_END===/p' prompts_output.txt | sed '1d;$d' > plan_prompt.txt
          # Extract implementation prompt
          sed -n '/===IMPL_PROMPT_START===/,/===IMPL_PROMPT_END===/p' prompts_output.txt | sed '1d;$d' > impl_prompt.txt
          # Output as multiline strings
          {
            echo 'plan_prompt<<EOF'
            cat plan_prompt.txt
            echo EOF
          } >> $GITHUB_OUTPUT
          {
            echo 'impl_prompt<<EOF'
            cat impl_prompt.txt
            echo EOF
          } >> $GITHUB_OUTPUT
        env:
          MARKDOWN_FILE: ${{ inputs.markdown_file }}

      - name: Run AI automation for docspec generate
        uses: docspec-ai/github-ai-actions@main
        with:
          provider: claude
          enable_plan: 'true'
          plan_prompt_template: ${{ steps.prepare_prompts.outputs.plan_prompt }}
          prompt_template: ${{ steps.prepare_prompts.outputs.impl_prompt }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch_prefix: "docs/generate-"
          pr_title_template: "Docs: generate and improve ${{ inputs.markdown_file }} and its docspec"
          pr_body_template: "Automated generation and improvements to ${{ inputs.markdown_file }} and its docspec file using Claude."

